# Production Docker Compose configuration for ConviveITESO
# Database: AWS RDS PostgreSQL (external) or dev database (CI mode)
version: '3.8'

networks:
  convive-network:
    external: ${CI:-false}
    name: ${COMPOSE_PROJECT_NAME:-convive-iteso-app}_default

services:
  # NestJS API Backend
  api:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile
    restart: unless-stopped
    ports:
      - "${API_PORT:-8080}:8080"
    networks:
      - convive-network
    # Runtime environment variables (DATABASE_URL, etc.)
    env_file:
      - ./apps/api/.env
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Next.js Web Frontend
  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
      args:
        # Build-time environment variable (compiled into Next.js bundle)
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:3000"
    networks:
      - convive-network
    depends_on:
      - api
    # Runtime environment variables (if needed)
    env_file:
      - ./apps/web/.env
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Notifications worker (BullMQ)
  notifications-worker:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile
    command: ["node", "apps/api/dist/src/notifications.worker.js"]
    restart: unless-stopped
    env_file:
      - ./apps/api/.env
    networks:
      - convive-network
    depends_on:
      - api
